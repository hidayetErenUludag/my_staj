import socket
import threading

# Constants
HOST = 'localhost'
PORT = 12345
MAX_BYTE = 1024

# Global variables
client_socket = None
reconnect_flag = True

# Serverdan gelen mesajlari dinler
def receive_messages(client_socket):
    global reconnect_flag
    while True:
        try:
            data = client_socket.recv(MAX_BYTE)
            if data:
                packet = Packet.from_bytes(data)
                print(
                    f"\n**\nGelen Paket: "
                    f"Source ID: {packet.source_id}, "
                    f"Message Type: {packet.message_type.name}, "
                    f"Message: {packet.message}\n**\n")
            else:
                break
        except:
            print("\nBağlantı koptu.")
            print("Tekrar Bağlanmak istiyor musunuz? Evet ise 1, Hayır ise 2 yazın.")
            try:
                user_input = int(input())
                if user_input == 1:
                    reconnect_flag = True
                else:
                    reconnect_flag = False
                break
            except ValueError:
                print("You must enter 1 or 2")
                reconnect_flag = False
                break

# TCP client'i başlatir
def start_client(host, port):
    global client_socket, reconnect_flag

    while reconnect_flag:
        try:
            client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            client_socket.connect((host, port))
            print("Bağlantı başarılı!")

            # Mesajlari ayri bir thread ile al
            receive_thread = threading.Thread(target=receive_messages, args=(client_socket,))
            receive_thread.start()
            receive_thread.join()  # Wait for the thread to finish

        except Exception as e:
            print(f"Bağlanamadı: {e}. \n Tekrar deneniyor...")

        if not reconnect_flag:
            break

# Start the client
start_client(HOST, PORT)
